/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package GetFile;


import java.io.File;
import java.io.IOException;
import java.net.URL;
import java.nio.file.Files;
import java.nio.file.Paths;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.swing.JFileChooser;

import org.apache.http.HttpEntity;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;



@WebServlet("/GetFile")

// file:c:/Users/hosoe/OneDrive/Documents/Hand-en.jpg課題1これでためす。
public class GetFile extends HttpServlet {

	protected void doPost(HttpServletRequest req, HttpServletResponse res)
			throws ServletException, IOException {

		//
		String input_URL = req.getParameter("URL");

    	// ダウンロードする URL
    	URL url = new URL(input_URL);
    	String fileName = Paths.get(url.getPath()).getFileName().toString();


        JFileChooser filechooser = new JFileChooser();
        filechooser.setCurrentDirectory(new File("C:\\"));
        filechooser.setSelectedFile(new File("C:\\", fileName));
        // デフォルトのファイル名を指定
        int select =filechooser.showSaveDialog(filechooser);
        // 保存ダイアログを表示

        if (select != JFileChooser.APPROVE_OPTION) {
          // 「保存」以外を押されたら終了
          System.out.println("HelloWorld");
        }

        File saveFile = filechooser.getSelectedFile();

        try (
                // HttpClientを設定
                final CloseableHttpClient client = HttpClients.createDefault();
                // Get
                final CloseableHttpResponse response = client.execute(new HttpGet(input_URL))) {
              // statusを確認して通信成功したらファイル保存
              final int status = response.getStatusLine().getStatusCode();
              if (status >= 200 && status < 300) {
                final HttpEntity entity = response.getEntity();
                // ファイル保存
                Files.write(Paths.get(saveFile.toString()),
                    entity == null ? new byte[0] : EntityUtils.toByteArray(entity));
              } else {
                throw new ClientProtocolException("Unexpected response status: " + status);
              }
            }
        	res.sendRedirect("http://localhost:8080/GetFile/index.jsp");
          }
        }